# 玩家模拟程序使用说明

本文档介绍如何使用两个Python玩家模拟程序来自动测试游戏服务器。

## 文件说明

- `player_bot_1.py` - 玩家模拟程序1
- `player_bot_2.py` - 玩家模拟程序2
- `bot_requirements.txt` - 机器人程序依赖

## 安装依赖

```bash
pip install -r bot_requirements.txt
```

## 使用步骤

### 1. 启动游戏服务器

首先确保游戏服务器正在运行：

```bash
cd /Users/yuning/workspace/SummerQuest-2025/game/server
python main.py
```

服务器将在 `http://localhost:8000` 启动。

### 2. 创建游戏房间

有两种方式创建房间：

**方式1：通过Web界面**
- 访问 `http://localhost:8000`
- 点击"创建房间"按钮
- 记录生成的房间ID（如：`abcd1234`）

**方式2：通过API**
```bash
curl -X POST http://localhost:8000/api/create_room
```

### 3. 运行玩家模拟程序

有两种方式运行机器人：

**方式1：自动化测试（推荐）**
```bash
cd /Users/yuning/workspace/SummerQuest-2025/game/players
python test_bots.py <房间ID>
```

该脚本会：
1. 验证指定房间ID的存在性和状态
2. 启动 `player_bot_1.py` 和 `player_bot_2.py`
3. 监控机器人的运行状态（显示前20行输出）
4. 显示实时输出和进程信息
5. 自动清理进程

**使用示例：**
```bash
# 假设已经创建了房间ID为 "room123" 的房间
cd /Users/yuning/workspace/SummerQuest-2025/game/players
python test_bots.py room123
```

**注意：** 在运行测试脚本之前，需要先手动创建房间或确保指定的房间ID存在。

**方式2：手动启动**
在两个不同的终端窗口中分别运行：

**终端1 - 启动玩家Bot1：**
```bash
cd /Users/yuning/workspace/SummerQuest-2025/game/players
python player_bot_1.py <房间ID>
```

**终端2 - 启动玩家Bot2：**
```bash
cd /Users/yuning/workspace/SummerQuest-2025/game/players
python player_bot_2.py <房间ID>
```

将 `<房间ID>` 替换为实际的房间ID。

## 功能特性

- **自动加入房间**：机器人会自动加入指定的游戏房间
- **智能同步**：等待所有玩家加入后再确认开始游戏
- **智能确认**：自动确认开始游戏，确保两个玩家都准备就绪
- **实时监听**：通过WebSocket监听游戏状态变化
- **自动出牌**：当轮到自己时会尝试出牌（目前为模拟）
- **错误处理**：包含完善的异常处理和日志输出
- **超时保护**：如果等待时间过长会自动退出

## 程序行为

### 玩家Bot1
- 加入指定房间
- 等待1秒后发送"确认开始游戏"请求
- 连接WebSocket监听游戏状态
- 轮到自己时，选择第一张手牌准备出牌
- 显示详细的操作日志，前缀为 `[玩家Bot1]`

### 玩家Bot2
- 加入指定房间
- 等待2秒后发送"确认开始游戏"请求
- 连接WebSocket监听游戏状态
- 轮到自己时，选择最后一张手牌准备出牌
- 显示详细的操作日志，前缀为 `[玩家Bot2]`

### 同步机制
- 机器人会等待房间状态变为"ready"（两个玩家都加入）
- 然后等待额外的时间确保同步
- 最后调用start_game确认开始游戏
- 包含30秒超时保护，如果等待时间过长会自动退出

## 故障排除

### 问题：第一个玩家加入了但没有准备

**原因**：游戏需要两个玩家都调用start_game API并标记为ready后才能开始。

**解决方案**：
- 机器人现在会等待房间状态变为"ready"（两个玩家都加入）
- 然后等待额外的时间确保同步
- 最后调用start_game确认开始游戏

**如果仍有问题**：
1. 检查服务器日志确认两个机器人都成功加入
2. 确认两个机器人都调用了start_game API
3. 检查网络连接是否稳定
4. 重新启动测试，确保服务器状态正常

### 问题：机器人连接超时

**解决方案**：
- 确保游戏服务器正在运行
- 检查端口8000是否被占用
- 确认防火墙设置允许本地连接

### 问题：WebSocket连接失败

**解决方案**：
- 检查服务器WebSocket端点是否正常
- 确认房间ID正确
- 重新启动服务器和机器人

## 示例运行流程

### 方式1：自动化测试（推荐）

1. **创建房间**：
   ```
   房间ID: abcd1234
   ```

2. **运行自动化测试**：
   ```bash
   python test_bots.py abcd1234
   ```
   输出：
   ```
   🤖 机器人测试工具
   本工具将使用指定房间ID启动两个机器人进行测试
   
   🏠 使用房间ID: abcd1234
   
   🚀 开始机器人测试...
   ==================================================
   📝 步骤1: 验证房间状态
   ✅ 房间存在，当前状态: waiting，玩家数量: 0
   🏠 房间ID: abcd1234
   ==================================================
   📝 步骤2: 启动机器人
   🤖 启动机器人: player_bot_1.py (PID: 12345)
   🤖 启动机器人: player_bot_2.py (PID: 12346)
   ==================================================
   📝 步骤3: 监控机器人运行（显示前20行输出）
   Bot1: [玩家Bot1] 启动，准备加入房间: abcd1234
   Bot1: [玩家Bot1] 成功加入房间 abcd1234，玩家key: xyz123
   Bot2: [玩家Bot2] 启动，准备加入房间: abcd1234
   Bot2: [玩家Bot2] 成功加入房间 abcd1234，玩家key: abc789
   Bot1: [玩家Bot1] 确认开始游戏: 等待其他玩家准备
   Bot2: [玩家Bot2] 确认开始游戏: 游戏开始！
   Bot1: [玩家Bot1] WebSocket连接成功
   Bot2: [玩家Bot2] WebSocket连接成功
   Bot1: [玩家Bot1] 游戏状态更新: playing
   Bot2: [玩家Bot2] 游戏状态更新: playing
   ==================================================
   📝 步骤4: 清理进程
   ✅ 机器人进程已清理
   ==================================================
   🎉 测试完成！
   ```

### 方式2：手动启动

1. **创建房间**：
   ```
   房间ID: abcd1234
   ```

2. **启动Bot1**：
   ```bash
   python player_bot_1.py abcd1234
   ```

3. **启动Bot2**：
   ```bash
   python player_bot_2.py abcd1234
   ```

4. **自动游戏**：
   两个机器人将自动进行游戏，当轮到各自回合时会尝试出牌。

## 注意事项

### 当前限制
- **出牌功能未完全实现**：目前服务器还没有实现出牌的API接口，所以机器人只能模拟选择要出的牌，但无法实际执行出牌操作。
- **游戏逻辑简化**：机器人使用简单的出牌策略（Bot1选第一张，Bot2选最后一张）。

### 扩展建议
为了完善机器人功能，建议在服务器中添加以下API：

1. **出牌API**：
   ```
   POST /api/play_card/{room_id}
   {
     "key": "player_key",
     "card_id": "card_123"
   }
   ```

2. **游戏操作API**：
   - 抽牌
   - 使用卡牌效果
   - 结束回合

### 调试技巧

1. **查看详细日志**：机器人会输出详细的操作日志，便于调试。

2. **监控WebSocket消息**：可以在代码中添加更多日志来查看WebSocket消息内容。

3. **手动测试**：可以同时打开Web界面观察游戏状态变化。

## 故障排除

### 常见问题

1. **连接失败**：
   - 确保游戏服务器正在运行
   - 检查端口8000是否被占用
   - 确认房间ID正确

2. **房间已满**：
   - 每个房间最多2名玩家
   - 创建新房间或等待现有玩家离开

3. **依赖缺失**：
   ```bash
   pip install -r bot_requirements.txt
   ```

4. **WebSocket连接失败**：
   - 检查防火墙设置
   - 确认WebSocket端点可访问

### 日志分析

正常运行时应该看到类似的日志序列：
```
[玩家Bot1] 启动，准备加入房间: abcd1234
[玩家Bot1] 成功加入房间 abcd1234，玩家key: xyz123
[玩家Bot1] 确认开始游戏: 等待其他玩家准备
[玩家Bot1] WebSocket连接成功
[玩家Bot1] 游戏状态更新: ready
[玩家Bot1] 游戏状态更新: playing
[玩家Bot1] 轮到我出牌了！
[玩家Bot1] 准备出牌: 卡牌名称 (ID: card_123)
[玩家Bot1] 注意：服务器尚未实现出牌API，无法实际出牌
```

## 未来改进

1. **智能出牌策略**：实现更复杂的AI决策逻辑
2. **配置文件支持**：允许自定义服务器地址、策略等
3. **批量测试**：支持同时运行多个机器人进行压力测试
4. **游戏记录**：保存游戏过程和结果用于分析
5. **可视化界面**：为机器人添加简单的监控界面